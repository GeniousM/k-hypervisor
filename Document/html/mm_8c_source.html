<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>khypervisor: mm.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">khypervisor
   &#160;<span id="projectnumber">v1</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">mm.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="mm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;k-hypervisor-config.h&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="mm_8h.html">mm.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;<a class="code" href="vmm_8h.html">vmm.h</a>&quot;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &quot;<a class="code" href="armv7__p15_8h.html">armv7_p15.h</a>&quot;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="arch__types_8h.html">arch_types.h</a>&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;config/memmap.cfg&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;log/print.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;log/uart_print.h&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="comment">/* LPAE Memory region attributes, to match Linux&#39;s (non-LPAE) choices.</span>
<a name="l00013"></a>00013 <span class="comment"> * Indexed by the AttrIndex bits of a LPAE entry;</span>
<a name="l00014"></a>00014 <span class="comment"> * the 8-bit fields are packed little-endian into MAIR0 and MAIR1</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> *                 ai    encoding</span>
<a name="l00017"></a>00017 <span class="comment"> *   UNCACHED      000   0000 0000  -- Strongly Ordered</span>
<a name="l00018"></a>00018 <span class="comment"> *   BUFFERABLE    001   0100 0100  -- Non-Cacheable</span>
<a name="l00019"></a>00019 <span class="comment"> *   WRITETHROUGH  010   1010 1010  -- Write-through</span>
<a name="l00020"></a>00020 <span class="comment"> *   WRITEBACK     011   1110 1110  -- Write-back</span>
<a name="l00021"></a>00021 <span class="comment"> *   DEV_SHARED    100   0000 0100  -- Device</span>
<a name="l00022"></a>00022 <span class="comment"> *   ??            101</span>
<a name="l00023"></a>00023 <span class="comment"> *   reserved      110</span>
<a name="l00024"></a>00024 <span class="comment"> *   WRITEALLOC    111   1111 1111  -- Write-back write-allocate</span>
<a name="l00025"></a>00025 <span class="comment"> *      </span>
<a name="l00026"></a>00026 <span class="comment"> *   DEV_NONSHARED 100   (== DEV_SHARED)</span>
<a name="l00027"></a>00027 <span class="comment"> *   DEV_WC        001   (== BUFFERABLE)</span>
<a name="l00028"></a>00028 <span class="comment"> *   DEV_CACHED    011   (== WRITEBACK)</span>
<a name="l00029"></a>00029 <span class="comment"> */</span> 
<a name="l00030"></a><a class="code" href="mm_8c.html#a2c907a8bc3ef7ca2e00817e63708771f">00030</a> <span class="preprocessor">#define INITIAL_MAIR0VAL 0xeeaa4400</span>
<a name="l00031"></a><a class="code" href="mm_8c.html#a2b56f7118e928dce984ab8eab8ebf79a">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define INITIAL_MAIR1VAL 0xff000004</span>
<a name="l00032"></a><a class="code" href="mm_8c.html#a0b13d4fb9fae8589866e218e964b9370">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define INITIAL_MAIRVAL (INITIAL_MAIR0VAL|INITIAL_MAIR1VAL&lt;&lt;32)</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="comment">/*</span>
<a name="l00035"></a>00035 <span class="comment"> * Attribute Indexes.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * These are valid in the AttrIndx[2:0] field of an LPAE stage 1 page</span>
<a name="l00038"></a>00038 <span class="comment"> * table entry. They are indexes into the bytes of the MAIR*</span>
<a name="l00039"></a>00039 <span class="comment"> * registers, as defined above.</span>
<a name="l00040"></a>00040 <span class="comment"> *</span>
<a name="l00041"></a>00041 <span class="comment"> */</span>
<a name="l00042"></a><a class="code" href="mm_8c.html#a81343c14ddcafbb7abd3d16a6611df84">00042</a> <span class="preprocessor">#define UNCACHED      0x0</span>
<a name="l00043"></a><a class="code" href="mm_8c.html#a320201c0180cde1303067f407f4d5390">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define BUFFERABLE    0x1</span>
<a name="l00044"></a><a class="code" href="mm_8c.html#ad9a3fc93c9a019f279e92ffe8737f081">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITETHROUGH  0x2</span>
<a name="l00045"></a><a class="code" href="mm_8c.html#a973016ed9f4fcee58ec1ae95d320c71c">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITEBACK     0x3</span>
<a name="l00046"></a><a class="code" href="mm_8c.html#acd04a0327233a94fd9f0a88e04b14ef5">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define DEV_SHARED    0x4</span>
<a name="l00047"></a><a class="code" href="mm_8c.html#ab6911c59f148d9d2e657db52adbac25a">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITEALLOC    0x7</span>
<a name="l00048"></a><a class="code" href="mm_8c.html#a8ea795955a5c505980ffeb556f28014b">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define DEV_NONSHARED DEV_SHARED</span>
<a name="l00049"></a><a class="code" href="mm_8c.html#a608a79b7dce3f91a5b67f8043cb3e875">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define DEV_WC        BUFFERABLE</span>
<a name="l00050"></a><a class="code" href="mm_8c.html#a67cca4ca72da021b000bfd4e001b851c">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define DEV_CACHED    WRITEBACK</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="comment">/* SCTLR System Control Register. */</span>
<a name="l00053"></a>00053 <span class="comment">/* HSCTLR is a subset of this. */</span>
<a name="l00054"></a><a class="code" href="mm_8c.html#a17a2bfe0d2848be36a2771b3ac4340d7">00054</a> <span class="preprocessor">#define SCTLR_TE        (1&lt;&lt;30)</span>
<a name="l00055"></a><a class="code" href="mm_8c.html#a2c6499f38b725ddf7325a2007460acd4">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_AFE       (1&lt;&lt;29)</span>
<a name="l00056"></a><a class="code" href="mm_8c.html#a5587f4833f6621424d36b694ca5cd4cb">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_TRE       (1&lt;&lt;28)</span>
<a name="l00057"></a><a class="code" href="mm_8c.html#a262333211dbe2b59bb5d8ba58e606451">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_NMFI      (1&lt;&lt;27)</span>
<a name="l00058"></a><a class="code" href="mm_8c.html#a84a7900092362ddcca33d5344ddc32d8">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_EE        (1&lt;&lt;25)</span>
<a name="l00059"></a><a class="code" href="mm_8c.html#a60713873cb7a4b52bab0bdc28c67a712">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_VE        (1&lt;&lt;24)</span>
<a name="l00060"></a><a class="code" href="mm_8c.html#a3c822cb745d3c523ebb0a8dbf06ed5a8">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_U         (1&lt;&lt;22)</span>
<a name="l00061"></a><a class="code" href="mm_8c.html#a72f5917646e2a5f6be4f20cdffdffafb">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_FI        (1&lt;&lt;21)</span>
<a name="l00062"></a><a class="code" href="mm_8c.html#a36a101e07390969e4dc8f697d21d9f26">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_WXN       (1&lt;&lt;19)</span>
<a name="l00063"></a><a class="code" href="mm_8c.html#aefdece0dbf293b2d2092e0e836361409">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_HA        (1&lt;&lt;17)</span>
<a name="l00064"></a><a class="code" href="mm_8c.html#aefac54b4d4c8d24ef6fe5ace19886508">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_RR        (1&lt;&lt;14)</span>
<a name="l00065"></a><a class="code" href="mm_8c.html#a74c261b86bd41bafb024ab40cf59a8a6">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_V         (1&lt;&lt;13)</span>
<a name="l00066"></a><a class="code" href="mm_8c.html#a4463aca82a645205290b851968b6a9a8">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_I         (1&lt;&lt;12)</span>
<a name="l00067"></a><a class="code" href="mm_8c.html#ad8d7b14b8e35c56f940185c098e8c014">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_Z         (1&lt;&lt;11)</span>
<a name="l00068"></a><a class="code" href="mm_8c.html#a59a947122b641ad6beb97aaa1a4d4495">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_SW        (1&lt;&lt;10)</span>
<a name="l00069"></a><a class="code" href="mm_8c.html#aa97e85698e9798c1bf4ad0e92174a4ef">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_B         (1&lt;&lt;7)</span>
<a name="l00070"></a><a class="code" href="mm_8c.html#ab29d865ad7a8a670db94641a194ccaf6">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_C         (1&lt;&lt;2)</span>
<a name="l00071"></a><a class="code" href="mm_8c.html#acf49275ed384ea3668029cb0d87f93d1">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_A         (1&lt;&lt;1)</span>
<a name="l00072"></a><a class="code" href="mm_8c.html#abe99dc6083b4bfc86a229928483c84a4">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_M         (1&lt;&lt;0)</span>
<a name="l00073"></a><a class="code" href="mm_8c.html#a4ecd7c7162537dc5ec433cf97037e3b8">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define SCTLR_BASE        0x00c50078</span>
<a name="l00074"></a><a class="code" href="mm_8c.html#ac0a5410252496a99d2ac094e358052da">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define HSCTLR_BASE       0x30c51878</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>
<a name="l00076"></a>00076 <span class="comment">/* HTTBR */</span>
<a name="l00077"></a><a class="code" href="mm_8c.html#a0c2db026d6f5b1ea43cd521c9b1599cd">00077</a> <span class="preprocessor">#define HTTBR_INITVAL                                   0x0000000000000000ULL</span>
<a name="l00078"></a><a class="code" href="mm_8c.html#ab0d4e7fe00a07b5a4bdae6dc2615c555">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTBR_BADDR_MASK                                0x000000FFFFFFF000ULL</span>
<a name="l00079"></a><a class="code" href="mm_8c.html#a21dc50b72e7a8cf33a6956eb1e967355">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define HTTBR_BADDR_SHIFT                               12</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="comment">/* HTCR */</span>
<a name="l00082"></a><a class="code" href="mm_8c.html#a980afbff15e420e0d24a4c32a4f798cd">00082</a> <span class="preprocessor">#define HTCR_INITVAL                                    0x80000000</span>
<a name="l00083"></a><a class="code" href="mm_8c.html#ae489b26e8b05f779ce527dd6d0a6bf46">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_SH0_MASK                                   0x00003000</span>
<a name="l00084"></a><a class="code" href="mm_8c.html#a6dd05fee64d85b254ebe89d7c168238c">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_SH0_SHIFT                                  12</span>
<a name="l00085"></a><a class="code" href="mm_8c.html#ae48872a50720e7834dc2474ff4013356">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_ORGN0_MASK                                 0x00000C00</span>
<a name="l00086"></a><a class="code" href="mm_8c.html#a87a919a03e888b586851dc151585c18d">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_ORGN0_SHIFT                                10</span>
<a name="l00087"></a><a class="code" href="mm_8c.html#a4666091a36af06e484bbb49b0b0c4375">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_IRGN0_MASK                                 0x00000300</span>
<a name="l00088"></a><a class="code" href="mm_8c.html#ac60d1dceadbae08549124e7ba63d1b7d">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_IRGN0_SHIFT                                8</span>
<a name="l00089"></a><a class="code" href="mm_8c.html#a7f8be03afc776f20725d0511fc6667e0">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_T0SZ_MASK                                  0x00000003</span>
<a name="l00090"></a><a class="code" href="mm_8c.html#a08a0f95a5f60965a28a8e850b6404c7a">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define HTCR_T0SZ_SHIFT                                 0</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a>00092 <span class="comment">/* PL2 Stage 1 Level 1 */</span>
<a name="l00093"></a><a class="code" href="mm_8c.html#a18bfc3cd96161f416a47db0a95832ab8">00093</a> <span class="preprocessor">#define HMM_L1_PTE_NUM  512</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a>00095 <span class="comment">/* PL2 Stage 1 Level 2 */</span>
<a name="l00096"></a><a class="code" href="mm_8c.html#a4f5f8a6a4d4322185db7a680f88a1a05">00096</a> <span class="preprocessor">#define HMM_L2_PTE_NUM  512</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a>00098 <span class="comment">/* PL2 Stage 1 Level 3 */</span>
<a name="l00099"></a><a class="code" href="mm_8c.html#ad3ad8bb977816662ac434c4730c7089b">00099</a> <span class="preprocessor">#define HMM_L3_PTE_NUM  512</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a><a class="code" href="mm_8c.html#ae6ea72ea9b13965ca0a411909cf1d836">00101</a> <span class="preprocessor">#define HEAP_ADDR CFG_MEMMAP_MON_OFFSET + 0x02000000</span>
<a name="l00102"></a><a class="code" href="mm_8c.html#a1b45302695680930829cac31d65e41e1">00102</a> <span class="preprocessor"></span><span class="preprocessor">#define HEAP_SIZE 0x0D000000</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a><a class="code" href="mm_8c.html#a7ea15d5cfd6345437fdfc7ebc2cbd369">00104</a> <span class="preprocessor">#define L2_ENTRY_MASK 0x1FF</span>
<a name="l00105"></a><a class="code" href="mm_8c.html#a7f3060298be5456735d84c0c3560aaf1">00105</a> <span class="preprocessor"></span><span class="preprocessor">#define L2_SHIFT 21</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>
<a name="l00107"></a><a class="code" href="mm_8c.html#a627fb02baa9a5ac0bee831e2ff62b4c0">00107</a> <span class="preprocessor">#define L3_ENTRY_MASK 0x1FF</span>
<a name="l00108"></a><a class="code" href="mm_8c.html#a9e6057f138b9dc38b717ec7e7548690d">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define L3_SHIFT 12</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a><a class="code" href="mm_8c.html#a3dae59fafa297ee1eeadf416db7b4b1e">00110</a> <span class="preprocessor">#define HEAP_END_ADDR HEAP_ADDR + HEAP_SIZE</span>
<a name="l00111"></a><a class="code" href="mm_8c.html#ac6dcef7a1829fc392ee1ed77205ec2ff">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define NALLOC 1024</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>
<a name="l00113"></a>00113 <span class="keyword">static</span> <a class="code" href="unionlpaed__t.html">lpaed_t</a> _hmm_pgtable[<a class="code" href="mm_8c.html#a18bfc3cd96161f416a47db0a95832ab8">HMM_L1_PTE_NUM</a>] <a class="code" href="context_8h.html#a06b520051af1c5c2e4d477566b23baa7">__attribute</a>((__aligned__(4096)));
<a name="l00114"></a>00114 <span class="keyword">static</span> <a class="code" href="unionlpaed__t.html">lpaed_t</a> _hmm_pgtable_l2[<a class="code" href="mm_8c.html#a4f5f8a6a4d4322185db7a680f88a1a05">HMM_L2_PTE_NUM</a>] <a class="code" href="context_8h.html#a06b520051af1c5c2e4d477566b23baa7">__attribute</a>((__aligned__(4096)));
<a name="l00115"></a>00115 <span class="keyword">static</span> <a class="code" href="unionlpaed__t.html">lpaed_t</a> _hmm_pgtable_l3[<a class="code" href="mm_8c.html#a4f5f8a6a4d4322185db7a680f88a1a05">HMM_L2_PTE_NUM</a>][<a class="code" href="mm_8c.html#ad3ad8bb977816662ac434c4730c7089b">HMM_L3_PTE_NUM</a>] <a class="code" href="context_8h.html#a06b520051af1c5c2e4d477566b23baa7">__attribute</a>((__aligned__(4096)));
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">/* used malloc, free, sbrk */</span>
<a name="l00118"></a><a class="code" href="mm_8c.html#aa508dd61e627680e57643837d292d89f">00118</a> <span class="keyword">typedef</span> <span class="keywordtype">long</span> <a class="code" href="mm_8c.html#aa508dd61e627680e57643837d292d89f">Align</a>;
<a name="l00119"></a><a class="code" href="unionheader.html">00119</a> <span class="keyword">union </span><a class="code" href="unionheader.html">header</a> {
<a name="l00120"></a>00120     <span class="keyword">struct </span>{
<a name="l00121"></a><a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">00121</a>         <span class="keyword">union </span><a class="code" href="unionheader.html">header</a> *<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>; <span class="comment">/* next block if on free list */</span>
<a name="l00122"></a><a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">00122</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a>; <span class="comment">/* size of this block */</span>
<a name="l00123"></a>00123     } <a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>;
<a name="l00124"></a>00124     <span class="comment">/* force align of blocks */</span>
<a name="l00125"></a><a class="code" href="unionheader.html#a5f369a9edd645986a45d0c159773c740">00125</a>     Align <a class="code" href="unionheader.html#a5f369a9edd645986a45d0c159773c740">x</a>;
<a name="l00126"></a>00126 };
<a name="l00127"></a>00127 <span class="comment">/* free list block header */</span>
<a name="l00128"></a><a class="code" href="mm_8c.html#a725658198c30a10bfdcc6bf6cf30f121">00128</a> <span class="keyword">typedef</span> <span class="keyword">union </span><a class="code" href="unionheader.html">header</a> <a class="code" href="unionheader.html">fl_bheader</a>;
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="mm_8c.html#aaeb50616cf303a81199782dccfe98461">00130</a> <a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="mm_8c.html#aaeb50616cf303a81199782dccfe98461">mm_break</a>; <span class="comment">/* break point for sbrk()  */</span>
<a name="l00131"></a><a class="code" href="mm_8c.html#a382bf173e93d5b52f7387b81913ddec5">00131</a> <a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="mm_8c.html#a382bf173e93d5b52f7387b81913ddec5">mm_prev_break</a>; <span class="comment">/* old break point for sbrk() */</span>
<a name="l00132"></a><a class="code" href="mm_8c.html#aa3abe9a33212c2a76ad5a5b311d9fdfb">00132</a> <a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="mm_8c.html#aa3abe9a33212c2a76ad5a5b311d9fdfb">last_valid_address</a>; <span class="comment">/* last mapping address */</span>
<a name="l00133"></a><a class="code" href="mm_8c.html#a793c43e1bf8501fea23668a2ab7a7021">00133</a> <span class="keyword">static</span> <a class="code" href="unionheader.html">fl_bheader</a> <a class="code" href="mm_8c.html#a793c43e1bf8501fea23668a2ab7a7021">freep_base</a>; <span class="comment">/* empty list to get started */</span>
<a name="l00134"></a><a class="code" href="mm_8c.html#a2af201098f51c02f77e15cd9c8e010eb">00134</a> <span class="keyword">static</span> <a class="code" href="unionheader.html">fl_bheader</a> *<a class="code" href="mm_8c.html#a2af201098f51c02f77e15cd9c8e010eb">freep</a>; <span class="comment">/* start of free list */</span>
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="comment">/* malloc init */</span>
<a name="l00137"></a><a class="code" href="mm_8c.html#a7c9c4518af771f7f39434b5dcc41d1d4">00137</a> <span class="keywordtype">void</span> <a class="code" href="mm_8c.html#a7c9c4518af771f7f39434b5dcc41d1d4">hmm_heap_init</a>(<span class="keywordtype">void</span>)
<a name="l00138"></a>00138 {
<a name="l00139"></a>00139     mm_break = <a class="code" href="mm_8c.html#ae6ea72ea9b13965ca0a411909cf1d836">HEAP_ADDR</a>;
<a name="l00140"></a>00140     mm_prev_break = <a class="code" href="mm_8c.html#ae6ea72ea9b13965ca0a411909cf1d836">HEAP_ADDR</a>;
<a name="l00141"></a>00141     last_valid_address = <a class="code" href="mm_8c.html#ae6ea72ea9b13965ca0a411909cf1d836">HEAP_ADDR</a>;
<a name="l00142"></a>00142     freep = 0;
<a name="l00143"></a>00143 } 
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="comment">/* </span>
<a name="l00146"></a>00146 <span class="comment"> * Initialization of Host Monitor Memory Management </span>
<a name="l00147"></a>00147 <span class="comment"> * PL2 Stage1 Translation</span>
<a name="l00148"></a>00148 <span class="comment"> * VA32 -&gt; PA</span>
<a name="l00149"></a>00149 <span class="comment"> */</span>
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="mm_8c.html#aa82c7756438b1aa5429be9ee49aea5ed">00151</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="mm_8c.html#aa82c7756438b1aa5429be9ee49aea5ed">_hmm_init</a>(<span class="keywordtype">void</span>)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="keywordtype">int</span> i, j;
<a name="l00154"></a>00154     <a class="code" href="arch__types_8h.html#aaa5d1cd013383c889537491c3cfd9aad">uint64_t</a> pa = 0x00000000ULL;
<a name="l00155"></a>00155     <span class="comment">/*</span>
<a name="l00156"></a>00156 <span class="comment">     * Partition 0: 0x00000000 ~ 0x3FFFFFFF - Peripheral - DEV_SHARED</span>
<a name="l00157"></a>00157 <span class="comment">     * Partition 1: 0x40000000 ~ 0x7FFFFFFF - Unused     - UNCACHED</span>
<a name="l00158"></a>00158 <span class="comment">     * Partition 2: 0x80000000 ~ 0xBFFFFFFF - Guest      - UNCACHED</span>
<a name="l00159"></a>00159 <span class="comment">     * Partition 3: 0xC0000000 ~ 0xFFFFFFFF - Monitor    - LV2 translation table address</span>
<a name="l00160"></a>00160 <span class="comment">     */</span>
<a name="l00161"></a>00161     _hmm_pgtable[0] = <a class="code" href="lpae_8c.html#aaa674eddb596444230e0aea1ba32e90e">hvmm_mm_lpaed_l1_block</a>(pa, <a class="code" href="mm_8c.html#acd04a0327233a94fd9f0a88e04b14ef5">DEV_SHARED</a>); pa += 0x40000000;
<a name="l00162"></a>00162     uart_print( <span class="stringliteral">&quot;&amp;_hmm_pgtable[0]:&quot;</span>); uart_print_hex32((<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) &amp;_hmm_pgtable[0]); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00163"></a>00163     uart_print( <span class="stringliteral">&quot;lpaed:&quot;</span>); uart_print_hex64(_hmm_pgtable[0].bits); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00164"></a>00164     _hmm_pgtable[1] = <a class="code" href="lpae_8c.html#aaa674eddb596444230e0aea1ba32e90e">hvmm_mm_lpaed_l1_block</a>(pa, <a class="code" href="mm_8c.html#a81343c14ddcafbb7abd3d16a6611df84">UNCACHED</a>); pa += 0x40000000;
<a name="l00165"></a>00165     uart_print( <span class="stringliteral">&quot;&amp;_hmm_pgtable[1]:&quot;</span>); uart_print_hex32((<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) &amp;_hmm_pgtable[1]); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00166"></a>00166     uart_print( <span class="stringliteral">&quot;lpaed:&quot;</span>); uart_print_hex64(_hmm_pgtable[1].bits); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00167"></a>00167     _hmm_pgtable[2] = <a class="code" href="lpae_8c.html#aaa674eddb596444230e0aea1ba32e90e">hvmm_mm_lpaed_l1_block</a>(pa, <a class="code" href="mm_8c.html#a81343c14ddcafbb7abd3d16a6611df84">UNCACHED</a>); pa += 0x40000000;
<a name="l00168"></a>00168     uart_print( <span class="stringliteral">&quot;&amp;_hmm_pgtable[2]:&quot;</span>); uart_print_hex32((<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) &amp;_hmm_pgtable[2]); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00169"></a>00169     uart_print( <span class="stringliteral">&quot;lpaed:&quot;</span>); uart_print_hex64(_hmm_pgtable[2].bits); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00170"></a>00170     <span class="comment">/* _hmm_pgtable[3] refers Lv2 page table address. */</span>
<a name="l00171"></a>00171     _hmm_pgtable[3] = <a class="code" href="lpae_8c.html#a804b9089155c7bc74ccea12d009c36fd">hvmm_mm_lpaed_l1_table</a>((<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) _hmm_pgtable_l2); 
<a name="l00172"></a>00172     uart_print( <span class="stringliteral">&quot;&amp;_hmm_pgtable[3]:&quot;</span>); uart_print_hex32((<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) &amp;_hmm_pgtable[3]); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00173"></a>00173     uart_print( <span class="stringliteral">&quot;lpaed:&quot;</span>); uart_print_hex64(_hmm_pgtable[3].bits); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00174"></a>00174     <span class="keywordflow">for</span>( i = 0; i &lt;<a class="code" href="mm_8c.html#a4f5f8a6a4d4322185db7a680f88a1a05">HMM_L2_PTE_NUM</a>; i++){
<a name="l00175"></a>00175         <span class="comment">/* _hvmm_pgtable_lv2[i] refers Lv3 page table address. each element correspond 2MB */</span>
<a name="l00176"></a>00176         _hmm_pgtable_l2[i] = <a class="code" href="lpae_8c.html#a6dba6fbdc7725faf61722eff42e18bbc">hvmm_mm_lpaed_l2_table</a>((<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) _hmm_pgtable_l3[i]); 
<a name="l00177"></a>00177         <span class="comment">/* _hvmm_pgtable_lv3[i][j] refers page, that size is 4KB */</span>
<a name="l00178"></a>00178         <span class="keywordflow">for</span>(j = 0; j &lt; <a class="code" href="mm_8c.html#ad3ad8bb977816662ac434c4730c7089b">HMM_L3_PTE_NUM</a>; pa += 0x1000 ,j++){
<a name="l00179"></a>00179             <span class="comment">/* 0xF2000000 ~ 0xFF000000 - Heap memory 208MB */</span>
<a name="l00180"></a>00180             <span class="keywordflow">if</span>(pa &gt;= <a class="code" href="mm_8c.html#ae6ea72ea9b13965ca0a411909cf1d836">HEAP_ADDR</a> &amp;&amp; pa &lt; <a class="code" href="mm_8c.html#ae6ea72ea9b13965ca0a411909cf1d836">HEAP_ADDR</a> + <a class="code" href="mm_8c.html#a1b45302695680930829cac31d65e41e1">HEAP_SIZE</a>){
<a name="l00181"></a>00181                 _hmm_pgtable_l3[i][j] = <a class="code" href="lpae_8c.html#a1f31704271c412a5077309bf60b83f86">hvmm_mm_lpaed_l3_table</a>(pa, <a class="code" href="mm_8c.html#ab6911c59f148d9d2e657db52adbac25a">WRITEALLOC</a>, 0);
<a name="l00182"></a>00182             }
<a name="l00183"></a>00183             <span class="keywordflow">else</span>{
<a name="l00184"></a>00184                 _hmm_pgtable_l3[i][j] = <a class="code" href="lpae_8c.html#a1f31704271c412a5077309bf60b83f86">hvmm_mm_lpaed_l3_table</a>(pa, <a class="code" href="mm_8c.html#a81343c14ddcafbb7abd3d16a6611df84">UNCACHED</a>, 1);
<a name="l00185"></a>00185             }
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188     <span class="keywordflow">for</span> ( i = 4; i &lt; <a class="code" href="mm_8c.html#a18bfc3cd96161f416a47db0a95832ab8">HMM_L1_PTE_NUM</a>; i++ ) {
<a name="l00189"></a>00189         _hmm_pgtable[i].pt.valid = 0;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="mm_8h.html#ae8f2b7d0b30b5fa78b50cee688872d93">00193</a> <span class="keywordtype">int</span> <a class="code" href="mm_8c.html#ae8f2b7d0b30b5fa78b50cee688872d93">hvmm_mm_init</a>(<span class="keywordtype">void</span>)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195 <span class="comment">/*</span>
<a name="l00196"></a>00196 <span class="comment"> *  MAIR0, MAIR1</span>
<a name="l00197"></a>00197 <span class="comment"> *  HMAIR0, HMAIR1</span>
<a name="l00198"></a>00198 <span class="comment"> *  HTCR</span>
<a name="l00199"></a>00199 <span class="comment"> *  HTCTLR</span>
<a name="l00200"></a>00200 <span class="comment"> *  HTTBR</span>
<a name="l00201"></a>00201 <span class="comment"> *  HTCTLR</span>
<a name="l00202"></a>00202 <span class="comment"> */</span>
<a name="l00203"></a>00203     <a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> mair, htcr, hsctlr, hcr;
<a name="l00204"></a>00204     <a class="code" href="arch__types_8h.html#aaa5d1cd013383c889537491c3cfd9aad">uint64_t</a> httbr;
<a name="l00205"></a>00205     uart_print( <span class="stringliteral">&quot;[mm] mm_init: enter\n\r&quot;</span> );
<a name="l00206"></a>00206     
<a name="l00207"></a>00207     <a class="code" href="vmm_8c.html#a34e0e13c32b08fd108582567c29ccebf">vmm_init</a>();
<a name="l00208"></a>00208     <a class="code" href="mm_8c.html#aa82c7756438b1aa5429be9ee49aea5ed">_hmm_init</a>();
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="comment">// MAIR/HMAIR</span>
<a name="l00211"></a>00211     uart_print(<span class="stringliteral">&quot; --- MAIR ----\n\r&quot;</span> );
<a name="l00212"></a>00212     mair = <a class="code" href="armv7__p15_8h.html#a9be943306a7c8c92e242d7b0c528c104">read_mair0</a>(); uart_print( <span class="stringliteral">&quot;mair0:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00213"></a>00213     mair = <a class="code" href="armv7__p15_8h.html#a4202580631120ea819013536d1764714">read_mair1</a>(); uart_print( <span class="stringliteral">&quot;mair1:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00214"></a>00214     mair = <a class="code" href="armv7__p15_8h.html#ad0f95cce118c43e27e56c573d2474589">read_hmair0</a>(); uart_print( <span class="stringliteral">&quot;hmair0:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00215"></a>00215     mair = <a class="code" href="armv7__p15_8h.html#a9c20c8c67832c7220daa6decf3716d3a">read_hmair1</a>(); uart_print( <span class="stringliteral">&quot;hmair1:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <a class="code" href="armv7__p15_8h.html#a4c688b4baf4bb99717ab883ec98731e3">write_mair0</a>( <a class="code" href="mm_8c.html#a2c907a8bc3ef7ca2e00817e63708771f">INITIAL_MAIR0VAL</a> );
<a name="l00218"></a>00218     <a class="code" href="armv7__p15_8h.html#a95ccc5e9e75f16d92e86e8c5e8795021">write_mair1</a>( <a class="code" href="mm_8c.html#a2b56f7118e928dce984ab8eab8ebf79a">INITIAL_MAIR1VAL</a> );
<a name="l00219"></a>00219     <a class="code" href="armv7__p15_8h.html#aceed5bc8f6ff935f285f0151d02984f4">write_hmair0</a>( <a class="code" href="mm_8c.html#a2c907a8bc3ef7ca2e00817e63708771f">INITIAL_MAIR0VAL</a> );
<a name="l00220"></a>00220     <a class="code" href="armv7__p15_8h.html#a28ff414c50b9d208a74c509495c03798">write_hmair1</a>( <a class="code" href="mm_8c.html#a2b56f7118e928dce984ab8eab8ebf79a">INITIAL_MAIR1VAL</a> );
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     mair = <a class="code" href="armv7__p15_8h.html#a9be943306a7c8c92e242d7b0c528c104">read_mair0</a>(); uart_print( <span class="stringliteral">&quot;mair0:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00223"></a>00223     mair = <a class="code" href="armv7__p15_8h.html#a4202580631120ea819013536d1764714">read_mair1</a>(); uart_print( <span class="stringliteral">&quot;mair1:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00224"></a>00224     mair = <a class="code" href="armv7__p15_8h.html#ad0f95cce118c43e27e56c573d2474589">read_hmair0</a>(); uart_print( <span class="stringliteral">&quot;hmair0:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00225"></a>00225     mair = <a class="code" href="armv7__p15_8h.html#a9c20c8c67832c7220daa6decf3716d3a">read_hmair1</a>(); uart_print( <span class="stringliteral">&quot;hmair1:&quot;</span>); uart_print_hex32(mair); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="comment">// HTCR</span>
<a name="l00228"></a>00228     uart_print(<span class="stringliteral">&quot; --- HTCR ----\n\r&quot;</span> );
<a name="l00229"></a>00229     htcr = <a class="code" href="armv7__p15_8h.html#a3a6bae959f288dba466eaf69ddb942af">read_htcr</a>(); uart_print( <span class="stringliteral">&quot;htcr:&quot;</span>); uart_print_hex32(htcr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00230"></a>00230     <a class="code" href="armv7__p15_8h.html#ac82f4f6d095d646b4c5dfe8ada9fb08b">write_htcr</a>( 0x80002500 );
<a name="l00231"></a>00231     htcr = <a class="code" href="armv7__p15_8h.html#a3a6bae959f288dba466eaf69ddb942af">read_htcr</a>(); uart_print( <span class="stringliteral">&quot;htcr:&quot;</span>); uart_print_hex32(htcr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     <span class="comment">// HSCTLR</span>
<a name="l00234"></a>00234     <span class="comment">// i-Cache and Alignment Checking Enabled</span>
<a name="l00235"></a>00235     <span class="comment">// MMU, D-cache, Write-implies-XN, Low-latency IRQs Disabled</span>
<a name="l00236"></a>00236     hsctlr = <a class="code" href="armv7__p15_8h.html#a13913f74bb5cce3c362082e705da87db">read_hsctlr</a>(); uart_print( <span class="stringliteral">&quot;hsctlr:&quot;</span>); uart_print_hex32(hsctlr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00237"></a>00237     hsctlr = <a class="code" href="mm_8c.html#ac0a5410252496a99d2ac094e358052da">HSCTLR_BASE</a> | <a class="code" href="mm_8c.html#acf49275ed384ea3668029cb0d87f93d1">SCTLR_A</a>;
<a name="l00238"></a>00238     <a class="code" href="armv7__p15_8h.html#a94fd8feb077baacec23b5626e75052d2">write_hsctlr</a>( hsctlr );
<a name="l00239"></a>00239     hsctlr = <a class="code" href="armv7__p15_8h.html#a13913f74bb5cce3c362082e705da87db">read_hsctlr</a>(); uart_print( <span class="stringliteral">&quot;hsctlr:&quot;</span>); uart_print_hex32(hsctlr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">// HCR</span>
<a name="l00243"></a>00243     hcr = <a class="code" href="armv7__p15_8h.html#a3b7662f2d5a21a8a49f06da2a29483ec">read_hcr</a>(); uart_print( <span class="stringliteral">&quot;hcr:&quot;</span>); uart_print_hex32(hcr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="comment">// HTCR</span>
<a name="l00246"></a>00246     <span class="comment">/*</span>
<a name="l00247"></a>00247 <span class="comment">     * Shareability - SH0[13:12] = 0 - Not shared</span>
<a name="l00248"></a>00248 <span class="comment">     * Outer Cacheability - ORGN0[11:10] = 11b - Write Back no Write Allocate Cacheable</span>
<a name="l00249"></a>00249 <span class="comment">     * Inner Cacheability - IRGN0[9:8] = 11b - Same</span>
<a name="l00250"></a>00250 <span class="comment">     * T0SZ[2:0] = 0 - 2^32 Input Address </span>
<a name="l00251"></a>00251 <span class="comment">     */</span>
<a name="l00252"></a>00252     <span class="comment">/* Untested code commented */</span>
<a name="l00253"></a>00253 <span class="comment">/*</span>
<a name="l00254"></a>00254 <span class="comment">    htcr = read_htcr(); uart_print( &quot;htcr:&quot;); uart_print_hex32(htcr); uart_print(&quot;\n\r&quot;);</span>
<a name="l00255"></a>00255 <span class="comment">    htcr &amp;= ~HTCR_SH0_MASK;</span>
<a name="l00256"></a>00256 <span class="comment">    htcr |= (0x0 &lt;&lt; HTCR_SH0_SHIFT) &amp; HTCR_SH0_MASK;</span>
<a name="l00257"></a>00257 <span class="comment">    htcr &amp;= ~HTCR_ORGN0_MASK;</span>
<a name="l00258"></a>00258 <span class="comment">    htcr |= (0x3 &lt;&lt; HTCR_ORGN0_SHIFT) &amp; HTCR_ORGN0_MASK;</span>
<a name="l00259"></a>00259 <span class="comment">    htcr &amp;= ~VTCR_IRGN0_MASK;</span>
<a name="l00260"></a>00260 <span class="comment">    htcr |= (0x3 &lt;&lt; HTCR_IRGN0_SHIFT) &amp; HTCR_IRGN0_MASK;</span>
<a name="l00261"></a>00261 <span class="comment">    htcr &amp;= ~VTCR_T0SZ_MASK;</span>
<a name="l00262"></a>00262 <span class="comment">    htcr |= (0x0 &lt;&lt; HTCR_T0SZ_SHIFT) &amp; HTCR_T0SZ_MASK;</span>
<a name="l00263"></a>00263 <span class="comment">    write_htcr( htcr );</span>
<a name="l00264"></a>00264 <span class="comment">    htcr = read_htcr(); uart_print( &quot;htcr:&quot;); uart_print_hex32(htcr); uart_print(&quot;\n\r&quot;);</span>
<a name="l00265"></a>00265 <span class="comment">*/</span>
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     <span class="comment">/* HTTBR = &amp;__hmm_pgtable */</span>
<a name="l00268"></a>00268     httbr = <a class="code" href="armv7__p15_8h.html#a814b3bae099b30c902bcd707bb4293a1">read_httbr</a>(); uart_print( <span class="stringliteral">&quot;httbr:&quot;</span> ); uart_print_hex64(httbr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00269"></a>00269     httbr &amp;= 0xFFFFFFFF00000000ULL;
<a name="l00270"></a>00270     httbr |= (<a class="code" href="arch__types_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>) &amp;_hmm_pgtable;
<a name="l00271"></a>00271     httbr &amp;= <a class="code" href="mm_8c.html#ab0d4e7fe00a07b5a4bdae6dc2615c555">HTTBR_BADDR_MASK</a>;
<a name="l00272"></a>00272     uart_print( <span class="stringliteral">&quot;writing httbr:&quot;</span> ); uart_print_hex64(httbr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00273"></a>00273     <a class="code" href="armv7__p15_8h.html#aadd0a0d0ee622916cac09b282b6b30ac">write_httbr</a>( httbr );
<a name="l00274"></a>00274     httbr = <a class="code" href="armv7__p15_8h.html#a814b3bae099b30c902bcd707bb4293a1">read_httbr</a>(); uart_print( <span class="stringliteral">&quot;read back httbr:&quot;</span> ); uart_print_hex64(httbr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="comment">/* Enable PL2 Stage 1 MMU */</span>
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     hsctlr = <a class="code" href="armv7__p15_8h.html#a13913f74bb5cce3c362082e705da87db">read_hsctlr</a>(); uart_print( <span class="stringliteral">&quot;hsctlr:&quot;</span>); uart_print_hex32(hsctlr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="comment">/* HSCTLR Enable MMU and D-cache */</span>
<a name="l00281"></a>00281     <span class="comment">// hsctlr |= (SCTLR_M |SCTLR_C);</span>
<a name="l00282"></a>00282     hsctlr |= (<a class="code" href="mm_8c.html#abe99dc6083b4bfc86a229928483c84a4">SCTLR_M</a>);
<a name="l00283"></a>00283     
<a name="l00284"></a>00284     <span class="comment">/* Flush PTE writes */</span>
<a name="l00285"></a>00285     <span class="keyword">asm</span>(<span class="stringliteral">&quot;dsb&quot;</span>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <a class="code" href="armv7__p15_8h.html#a94fd8feb077baacec23b5626e75052d2">write_hsctlr</a>( hsctlr );
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     <span class="comment">/* Flush iCache */</span>
<a name="l00290"></a>00290     <span class="keyword">asm</span>(<span class="stringliteral">&quot;isb&quot;</span>);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     hsctlr = <a class="code" href="armv7__p15_8h.html#a13913f74bb5cce3c362082e705da87db">read_hsctlr</a>(); uart_print( <span class="stringliteral">&quot;hsctlr:&quot;</span>); uart_print_hex32(hsctlr); uart_print(<span class="stringliteral">&quot;\n\r&quot;</span>);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <a class="code" href="mm_8c.html#a7c9c4518af771f7f39434b5dcc41d1d4">hmm_heap_init</a>();
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     uart_print( <span class="stringliteral">&quot;[mm] mm_init: exit\n\r&quot;</span> );
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="keywordflow">return</span> <a class="code" href="hvmm__types_8h.html#a39d593b2c97852f566d7472b76ab7ba2addc8231abb0339e0a6abc0d34b156faf">HVMM_STATUS_SUCCESS</a>;
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 
<a name="l00301"></a><a class="code" href="mm_8c.html#a8c6819b2416a9da42da9a5ac8d1a9d51">00301</a> <span class="keywordtype">void</span> <a class="code" href="mm_8c.html#a8c6819b2416a9da42da9a5ac8d1a9d51">hmm_flushTLB</a>(<span class="keywordtype">void</span>)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303     <span class="comment">/* Invalidate entire unified TLB */</span>
<a name="l00304"></a>00304     <a class="code" href="armv7__p15_8h.html#a8983432e251fc0069019ae2e253e1765">invalidate_unified_tlb</a>(0);
<a name="l00305"></a>00305     <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;dsb&quot;</span>);
<a name="l00306"></a>00306     <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;isb&quot;</span>);
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a><a class="code" href="mm_8c.html#a2474e37847535a7ab59fcef069a3b63a">00309</a> <a class="code" href="unionlpaed__t.html">lpaed_t</a>* <a class="code" href="mm_8c.html#a2474e37847535a7ab59fcef069a3b63a">hmm_get_l3_table_entry</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> virt, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> npages)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311     <span class="keywordtype">int</span> l2_index = (virt &gt;&gt; <a class="code" href="mm_8c.html#a7f3060298be5456735d84c0c3560aaf1">L2_SHIFT</a>) &amp; <a class="code" href="mm_8c.html#a7ea15d5cfd6345437fdfc7ebc2cbd369">L2_ENTRY_MASK</a>;
<a name="l00312"></a>00312     <span class="keywordtype">int</span> l3_index = (virt &gt;&gt; <a class="code" href="mm_8c.html#a9e6057f138b9dc38b717ec7e7548690d">L3_SHIFT</a>) &amp; <a class="code" href="mm_8c.html#a627fb02baa9a5ac0bee831e2ff62b4c0">L3_ENTRY_MASK</a>;
<a name="l00313"></a>00313     <span class="keywordtype">int</span> maxsize = ((<a class="code" href="mm_8c.html#a4f5f8a6a4d4322185db7a680f88a1a05">HMM_L2_PTE_NUM</a> * <a class="code" href="mm_8c.html#ad3ad8bb977816662ac434c4730c7089b">HMM_L3_PTE_NUM</a>) - ( (l2_index + 1) * (l3_index + 1) ) + 1);
<a name="l00314"></a>00314     <span class="keywordflow">if</span>( maxsize &lt; npages ) {
<a name="l00315"></a>00315         printh(<span class="stringliteral">&quot;%s[%d] : Map size \&quot;pages\&quot; is exceeded memory size\n&quot;</span>, __FUNCTION__, __LINE__);
<a name="l00316"></a>00316         <span class="keywordflow">if</span>(maxsize &gt; 0){
<a name="l00317"></a>00317             printh(<span class="stringliteral">&quot;%s[%d] : Available pages are %d\n&quot;</span>, maxsize); 
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         <span class="keywordflow">else</span>{
<a name="l00320"></a>00320             printh(<span class="stringliteral">&quot;%s[%d] : Do not have available pages for map\n&quot;</span>);
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322         <span class="keywordflow">return</span> 0;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324     <span class="keywordflow">return</span> &amp;_hmm_pgtable_l3[l2_index][l3_index];
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a><a class="code" href="mm_8h.html#a4ca7bdd94dcc4cfff4b534b6ba0c7493">00327</a> <span class="keywordtype">void</span> <a class="code" href="mm_8c.html#a4ca7bdd94dcc4cfff4b534b6ba0c7493">hmm_umap</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> virt, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> npages)
<a name="l00328"></a>00328 { 
<a name="l00329"></a>00329     <span class="keywordtype">int</span>  i;
<a name="l00330"></a>00330     <a class="code" href="unionlpaed__t.html">lpaed_t</a>* map_table_p = <a class="code" href="mm_8c.html#a2474e37847535a7ab59fcef069a3b63a">hmm_get_l3_table_entry</a>( virt, npages );
<a name="l00331"></a>00331     <span class="keywordflow">for</span>( i = 0; i &lt; npages; i++){
<a name="l00332"></a>00332         <a class="code" href="lpae_8c.html#a8ab1751ba62e519b19560863ee75fbf8">lpaed_stage1_disable_l3_table</a>( &amp;map_table_p[i] );
<a name="l00333"></a>00333     }
<a name="l00334"></a>00334     <a class="code" href="mm_8c.html#a8c6819b2416a9da42da9a5ac8d1a9d51">hmm_flushTLB</a>();
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a><a class="code" href="mm_8h.html#addc0cbf4f901eef091961846460ab81f">00337</a> <span class="keywordtype">void</span> <a class="code" href="mm_8c.html#addc0cbf4f901eef091961846460ab81f">hmm_map</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> phys, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> virt, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> npages)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339     <span class="keywordtype">int</span> i;
<a name="l00340"></a>00340     <a class="code" href="unionlpaed__t.html">lpaed_t</a>* map_table_p = <a class="code" href="mm_8c.html#a2474e37847535a7ab59fcef069a3b63a">hmm_get_l3_table_entry</a>( virt, npages );
<a name="l00341"></a>00341     <span class="keywordflow">for</span>( i = 0; i &lt; npages; i++){
<a name="l00342"></a>00342         <a class="code" href="lpae_8c.html#a7063374a9b74906e426f94dc544b132b">lpaed_stage1_conf_l3_table</a>( &amp;map_table_p[i], (<a class="code" href="arch__types_8h.html#aaa5d1cd013383c889537491c3cfd9aad">uint64_t</a>)phys, 1 );
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344     <a class="code" href="mm_8c.html#a8c6819b2416a9da42da9a5ac8d1a9d51">hmm_flushTLB</a>();
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="comment">/* General-purpose sbrk, basic memory management system calls </span>
<a name="l00348"></a>00348 <span class="comment"> * Returns -1 if there was no space.</span>
<a name="l00349"></a>00349 <span class="comment">*/</span>
<a name="l00350"></a><a class="code" href="mm_8c.html#aed9cb3337e230955ad366c56c50f1c9e">00350</a> <span class="keywordtype">void</span> *<a class="code" href="mm_8c.html#aed9cb3337e230955ad366c56c50f1c9e">hmm_sbrk</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> incr)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> required_addr;
<a name="l00353"></a>00353     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> virt;
<a name="l00354"></a>00354     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> required_pages = 0;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     mm_prev_break = <a class="code" href="mm_8c.html#aaeb50616cf303a81199782dccfe98461">mm_break</a>;
<a name="l00357"></a>00357     virt = <a class="code" href="mm_8c.html#aaeb50616cf303a81199782dccfe98461">mm_break</a>;
<a name="l00358"></a>00358     mm_break += incr;
<a name="l00359"></a>00359     <span class="keywordflow">if</span>( mm_break &gt; last_valid_address ){
<a name="l00360"></a>00360         required_addr = mm_break - <a class="code" href="mm_8c.html#aa3abe9a33212c2a76ad5a5b311d9fdfb">last_valid_address</a>;
<a name="l00361"></a>00361         <span class="keywordflow">for</span>( ;required_addr &gt; 0x0; required_addr -= 0x1000){
<a name="l00362"></a>00362             <span class="keywordflow">if</span>( last_valid_address + 0x1000 &gt; <a class="code" href="mm_8c.html#a3dae59fafa297ee1eeadf416db7b4b1e">HEAP_END_ADDR</a> ){
<a name="l00363"></a>00363                 printh(<span class="stringliteral">&quot;%s[%d] required address is exceeded heap memory size\n&quot;</span>, __FUNCTION__, __LINE__);
<a name="l00364"></a>00364                 <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)-1;
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366             last_valid_address += 0x1000;
<a name="l00367"></a>00367             required_pages++;
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369         <a class="code" href="mm_8c.html#addc0cbf4f901eef091961846460ab81f">hmm_map</a>(virt, virt, required_pages);
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371     <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)<a class="code" href="mm_8c.html#a382bf173e93d5b52f7387b81913ddec5">mm_prev_break</a>;
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a><a class="code" href="mm_8h.html#ac1edcf1771542874ebcf1a67ceb90a92">00374</a> <span class="keywordtype">void</span> <a class="code" href="mm_8c.html#ab7237ca6c0b383d215c263b9f1855388">hmm_free</a>(<span class="keywordtype">void</span>* ap)
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376     <a class="code" href="unionheader.html">fl_bheader</a> *bp, *p;
<a name="l00377"></a>00377     bp = (<a class="code" href="unionheader.html">fl_bheader</a> *)ap - 1; <span class="comment">/* point to block header */</span>
<a name="l00378"></a>00378     <span class="keywordflow">for</span> (p = freep; !(bp &gt; p &amp;&amp; bp  &lt; p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>); p = p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>){
<a name="l00379"></a>00379         <span class="keywordflow">if</span>(p &gt;= p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> &amp;&amp; (bp &gt; p || bp &lt; p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.ptr)){
<a name="l00380"></a>00380             <span class="keywordflow">break</span>; <span class="comment">/* freed block at start or end of arena */</span>
<a name="l00381"></a>00381         }
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383     <span class="keywordflow">if</span>(bp + bp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> == p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>) { <span class="comment">/* join to upper nbr */</span>
<a name="l00384"></a>00384         bp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> += p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a>;
<a name="l00385"></a>00385         bp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> = p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>;
<a name="l00386"></a>00386     } <span class="keywordflow">else</span>
<a name="l00387"></a>00387         bp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> = p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>;
<a name="l00388"></a>00388     <span class="keywordflow">if</span> (p + p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> == bp) {      <span class="comment">/* join to lower nbr */</span>
<a name="l00389"></a>00389         p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> += bp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a>;
<a name="l00390"></a>00390         p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> = bp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>;
<a name="l00391"></a>00391     } <span class="keywordflow">else</span>
<a name="l00392"></a>00392         p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> = bp;
<a name="l00393"></a>00393     freep = p;
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="mm_8c.html#a50b17e6b64d9c0892bce1d8585e4f6a7">00396</a> <span class="keyword">static</span> <a class="code" href="unionheader.html">fl_bheader</a> *<a class="code" href="mm_8c.html#a50b17e6b64d9c0892bce1d8585e4f6a7">morecore</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nu)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <span class="keywordtype">char</span> *cp;
<a name="l00399"></a>00399     <a class="code" href="unionheader.html">fl_bheader</a> *up;
<a name="l00400"></a>00400     <span class="keywordflow">if</span> ( nu &lt; <a class="code" href="mm_8c.html#ac6dcef7a1829fc392ee1ed77205ec2ff">NALLOC</a> )
<a name="l00401"></a>00401         nu = <a class="code" href="mm_8c.html#ac6dcef7a1829fc392ee1ed77205ec2ff">NALLOC</a>;
<a name="l00402"></a>00402     cp = <a class="code" href="mm_8c.html#aed9cb3337e230955ad366c56c50f1c9e">hmm_sbrk</a>(nu * <span class="keyword">sizeof</span>(<a class="code" href="unionheader.html">fl_bheader</a>));
<a name="l00403"></a>00403     <span class="keywordflow">if</span> ( cp == (<span class="keywordtype">char</span> *) -1 ) <span class="comment">/* no space at all */</span>
<a name="l00404"></a>00404         <span class="keywordflow">return</span> 0;
<a name="l00405"></a>00405     up = (<a class="code" href="unionheader.html">fl_bheader</a> *)cp;
<a name="l00406"></a>00406     up-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> = nu;
<a name="l00407"></a>00407     <a class="code" href="mm_8c.html#ab7237ca6c0b383d215c263b9f1855388">hmm_free</a>((<span class="keywordtype">void</span>*)(up+1));
<a name="l00408"></a>00408     <span class="keywordflow">return</span> <a class="code" href="mm_8c.html#a2af201098f51c02f77e15cd9c8e010eb">freep</a>;
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="mm_8h.html#a3421aed4792b89e78be604efbae319dc">00411</a> <span class="keywordtype">void</span>* <a class="code" href="mm_8c.html#a3421aed4792b89e78be604efbae319dc">hmm_malloc</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a>)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <a class="code" href="unionheader.html">fl_bheader</a> *p, *prevp;
<a name="l00414"></a>00414     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nunits; 
<a name="l00415"></a>00415     nunits = (size + <span class="keyword">sizeof</span>(<a class="code" href="mm_8c.html#a725658198c30a10bfdcc6bf6cf30f121">fl_bheader</a>) - 1)/<span class="keyword">sizeof</span>(<a class="code" href="mm_8c.html#a725658198c30a10bfdcc6bf6cf30f121">fl_bheader</a>) + 1;
<a name="l00416"></a>00416     <span class="keywordflow">if</span>(nunits &lt; 2){
<a name="l00417"></a>00417         <span class="keywordflow">return</span> 0;
<a name="l00418"></a>00418     }
<a name="l00419"></a>00419     
<a name="l00420"></a>00420     <span class="keywordflow">if</span> ((prevp = freep) == 0 ) { <span class="comment">/* no free list yet */</span>
<a name="l00421"></a>00421         freep_base.<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> = freep = prevp = &amp;<a class="code" href="mm_8c.html#a793c43e1bf8501fea23668a2ab7a7021">freep_base</a>;
<a name="l00422"></a>00422         freep_base.<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> = 0;
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     <span class="keywordflow">for</span> ( p = prevp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>; ; prevp = p, p = p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>) {
<a name="l00425"></a>00425         <span class="keywordflow">if</span> ( p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> &gt;= nunits ) { <span class="comment">/* big enough */</span>
<a name="l00426"></a>00426             <span class="keywordflow">if</span> ( p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> == nunits ) <span class="comment">/* exactly */</span>
<a name="l00427"></a>00427                 prevp-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a> = p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#a0e84d7fb56aa45d0a3eb7083a5ff1b63">ptr</a>;
<a name="l00428"></a>00428             <span class="keywordflow">else</span> {                    <span class="comment">/* allocate tail end */</span>
<a name="l00429"></a>00429                 p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> -= nunits;
<a name="l00430"></a>00430                 p += p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a>;
<a name="l00431"></a>00431                 p-&gt;<a class="code" href="unionheader.html#a958d7cb7719f42c07c1a600553d0db44">s</a>.<a class="code" href="unionheader.html#aac913b3a1f6ef005d66bf7a84428773e">size</a> = nunits;
<a name="l00432"></a>00432             }
<a name="l00433"></a>00433             freep = prevp;
<a name="l00434"></a>00434             <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)(p+1);
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="keywordflow">if</span> ( p == freep )   <span class="comment">/* wrapped around free list */</span>
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (( p = <a class="code" href="mm_8c.html#a50b17e6b64d9c0892bce1d8585e4f6a7">morecore</a>(nunits)) == 0 )
<a name="l00438"></a>00438                 <span class="keywordflow">return</span> 0;  <span class="comment">/* none avaliable memory left */</span>
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Feb 18 2014 16:44:40 for khypervisor by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
